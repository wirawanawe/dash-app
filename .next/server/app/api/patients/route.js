"use strict";(()=>{var e={};e.id=4068,e.ids=[4068],e.modules={10846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{e.exports=require("buffer")},55511:e=>{e.exports=require("crypto")},94735:e=>{e.exports=require("events")},29021:e=>{e.exports=require("fs")},91645:e=>{e.exports=require("net")},21820:e=>{e.exports=require("os")},33873:e=>{e.exports=require("path")},19771:e=>{e.exports=require("process")},27910:e=>{e.exports=require("stream")},41204:e=>{e.exports=require("string_decoder")},66136:e=>{e.exports=require("timers")},34631:e=>{e.exports=require("tls")},79551:e=>{e.exports=require("url")},28354:e=>{e.exports=require("util")},74075:e=>{e.exports=require("zlib")},855:(e,t,a)=>{a.r(t),a.d(t,{patchFetch:()=>f,routeModule:()=>c,serverHooks:()=>y,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>g});var r={};a.r(r),a.d(r,{GET:()=>u,POST:()=>m});var i=a(42706),n=a(28203),o=a(45994),s=a(39187);a(19637);var l=a(99527);let p=e=>new Promise(t=>setTimeout(t,e));async function d(e,t,a=3){for(let r=0;r<a;r++)try{return await fetch(e,{...t,timeout:3e4})}catch(e){if(console.log(`Attempt ${r+1} failed:`,e.message),r===a-1)throw e;await p(1e3*Math.pow(2,r))}}async function u(e){try{let{searchParams:t}=new URL(e.url),a=t.get("search")||"",r=parseInt(t.get("page")||"1"),i=parseInt(t.get("limit")||"10"),n=[],o=0;if(a){let e=1,t=!0;try{for(;t;){let r=`http://api-klinik.doctorphc.id/pasien?page=${e}&limit=50`;console.log(`Fetching batch ${e} for search: ${a}`);let i=await d(r,{method:"GET",headers:{"Content-Type":"application/json"}});if(!i.ok){console.error(`API responded with status: ${i.status}`);break}let o=await i.json(),s=[];if(o.data&&Array.isArray(o.data)?s=o.data:Array.isArray(o)&&(s=o),0===s.length){t=!1;break}let l=s.map(e=>({id:e.No_MR,mrn:e.No_MR,name:e.Nama_Pasien,gender:e.Jenis_Kelamin?.[0]?.name||"-",birthDate:e.Tgl_Lahir?e.Tgl_Lahir.split(" ")[0]:null,nik:e.Identitas?.find(e=>"nik"===e.type)?.id||"",nip:e.Identitas?.find(e=>"nip"===e.type)?.id||"",phone:"",address:e.Alamat_Rumah?.[0]?.Alamat||"",city:e.Alamat_Rumah?.[0]?.Kota?.[0]?.name||"",province:e.Alamat_Rumah?.[0]?.Propinsi?.[0]?.name||"",bloodType:e.Golongan_Darah?.[0]?.name||"-",religion:e.Agama?.[0]?.name||"-",maritalStatus:e.Status_Marital?.[0]?.name||"-",occupation:e.Pekerjaan?.[0]?.name||"-",education:e.Pendidikan?.[0]?.name||"-",created_at:e.audittrail?.CreatedDate||null,updated_at:e.audittrail?.LastModifiedDate||null}));n.push(...l),s.length<50?t=!1:e++,e>50&&(console.log("Reached maximum page limit for search"),t=!1),t&&await p(500)}console.log(`Search completed. Found ${n.length} total patients to filter`)}catch(e){if(console.error("Error during batch fetching:",e),0===n.length){console.log("Falling back to single page fetch due to batch fetch error");try{let e=await d("http://api-klinik.doctorphc.id/pasien?page=1&limit=100",{method:"GET",headers:{"Content-Type":"application/json"}});if(e.ok){let t=await e.json(),a=[];t.data&&Array.isArray(t.data)?a=t.data:Array.isArray(t)&&(a=t),n=a.map(e=>({id:e.No_MR,mrn:e.No_MR,name:e.Nama_Pasien,gender:e.Jenis_Kelamin?.[0]?.name||"-",birthDate:e.Tgl_Lahir?e.Tgl_Lahir.split(" ")[0]:null,nik:e.Identitas?.find(e=>"nik"===e.type)?.id||"",nip:e.Identitas?.find(e=>"nip"===e.type)?.id||"",phone:"",address:e.Alamat_Rumah?.[0]?.Alamat||"",city:e.Alamat_Rumah?.[0]?.Kota?.[0]?.name||"",province:e.Alamat_Rumah?.[0]?.Propinsi?.[0]?.name||"",bloodType:e.Golongan_Darah?.[0]?.name||"-",religion:e.Agama?.[0]?.name||"-",maritalStatus:e.Status_Marital?.[0]?.name||"-",occupation:e.Pekerjaan?.[0]?.name||"-",education:e.Pendidikan?.[0]?.name||"-",created_at:e.audittrail?.CreatedDate||null,updated_at:e.audittrail?.LastModifiedDate||null}))}}catch(e){return console.error("Fallback fetch also failed:",e),s.NextResponse.json({data:[],pagination:{total:0,page:r,limit:i,totalPages:0},message:"Search temporarily unavailable due to API issues"})}}}let l=n.filter(e=>e.name&&e.name.toLowerCase().includes(a.toLowerCase())||e.mrn&&e.mrn.toLowerCase().includes(a.toLowerCase())||e.nik&&e.nik.toLowerCase().includes(a.toLowerCase()));console.log(`Found ${l.length} patients matching search: "${a}"`);let u=(r-1)*i,m=l.slice(u,u+i);o=l.length;let c=Math.ceil(o/i);return s.NextResponse.json({data:m,pagination:{total:o,page:r,limit:i,totalPages:c}})}{let e=`http://api-klinik.doctorphc.id/pasien?page=${r}&limit=${i}`,t=await d(e,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)throw Error(`Failed to fetch from external API: ${t.status} ${t.statusText}`);let a=await t.json(),n=[];a.data&&Array.isArray(a.data)?n=a.data:Array.isArray(a)&&(n=a);let l=n.map(e=>({id:e.No_MR,mrn:e.No_MR,name:e.Nama_Pasien,gender:e.Jenis_Kelamin?.[0]?.name||"-",birthDate:e.Tgl_Lahir?e.Tgl_Lahir.split(" ")[0]:null,nik:e.Identitas?.find(e=>"nik"===e.type)?.id||"",nip:e.Identitas?.find(e=>"nip"===e.type)?.id||"",phone:"",address:e.Alamat_Rumah?.[0]?.Alamat||"",city:e.Alamat_Rumah?.[0]?.Kota?.[0]?.name||"",province:e.Alamat_Rumah?.[0]?.Propinsi?.[0]?.name||"",bloodType:e.Golongan_Darah?.[0]?.name||"-",religion:e.Agama?.[0]?.name||"-",maritalStatus:e.Status_Marital?.[0]?.name||"-",occupation:e.Pekerjaan?.[0]?.name||"-",education:e.Pendidikan?.[0]?.name||"-",created_at:e.audittrail?.CreatedDate||null,updated_at:e.audittrail?.LastModifiedDate||null}));o=a["total pasien"]||a.total||l.length;let p=Math.ceil(o/i);return s.NextResponse.json({data:l,pagination:{total:o,page:r,limit:i,totalPages:p}})}}catch(e){return console.error("Error fetching patients from external API:",e),s.NextResponse.json({message:"Failed to fetch patients from external API",error:e.message},{status:500})}}async function m(e){try{let t=await e.json();if(!t.name||!t.nik||!t.birthDate)return new s.NextResponse(JSON.stringify({error:"Nama, NIK, dan Tanggal Lahir wajib diisi"}),{status:400,headers:{"Content-Type":"application/json"}});let a=new Date().getFullYear(),r=await l.Gp.findFirst({where:{mrNumber:{startsWith:`MR-${a}`}},orderBy:{mrNumber:"desc"}}),i=r?parseInt(r.mrNumber.split("-")[2])+1:1,n=`MR-${a}-${i.toString().padStart(4,"0")}`,o=await l.Gp.create({data:{mrNumber:n,name:t.name.trim(),nik:t.nik.trim(),birthDate:new Date(t.birthDate),gender:t.gender||null,bloodType:t.bloodType||null,occupation:t.occupation||null,maritalStatus:t.maritalStatus||null,nip:t.nip||null,citizenship:t.citizenship||"WNI",address:t.address?.trim()||null,phone:t.phone?.trim()||null,email:t.email?.trim()||null,provinceId:t.provinceId||null,provinceName:t.provinceName||null,cityId:t.cityId||null,cityName:t.cityName||null,districtId:t.districtId||null,districtName:t.districtName||null,villageId:t.villageId||null,villageName:t.villageName||null,postalCode:t.postalCode||null,companyId:t.companyId||null}});t.insurance&&await l.hL.create({data:{patientId:o.id,provider:t.insurance.provider,number:t.insurance.number||null,type:t.insurance.type||null,status:t.insurance.status||"Aktif"}});let p={...o,birthDate:o.birthDate?o.birthDate.toISOString().split("T")[0]:null,createdAt:o.createdAt?o.createdAt.toISOString():null,updatedAt:o.updatedAt?o.updatedAt.toISOString():null};return new s.NextResponse(JSON.stringify(p),{status:201,headers:{"Content-Type":"application/json"}})}catch(e){if(console.error("Error creating patient:",e),"P2002"===e.code||"ER_DUP_ENTRY"===e.code)return new s.NextResponse(JSON.stringify({error:"NIK sudah terdaftar"}),{status:400,headers:{"Content-Type":"application/json"}});return new s.NextResponse(JSON.stringify({error:"Gagal menambahkan pasien"}),{status:500,headers:{"Content-Type":"application/json"}})}}let c=new i.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/patients/route",pathname:"/api/patients",filename:"route",bundlePath:"app/api/patients/route"},resolvedPagePath:"/Volumes/Data-2/PHC/Project/dash-app/app/api/patients/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:h,workUnitAsyncStorage:g,serverHooks:y}=c;function f(){return(0,o.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:g})}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[5994,5452,6673,6821],()=>a(855));module.exports=r})();